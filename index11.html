<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Runner â€“ Jump, Restart & Score</title>
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
  #ui {
    position:absolute;
    bottom:20px;
    width:100%;
    text-align:center;
    z-index:10;
  }
  button {
    background:#ff6600;
    border:none;
    color:#fff;
    font-size:20px;
    padding:10px 18px;
    margin:0 8px;
    border-radius:10px;
    cursor:pointer;
  }
  #status {
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:#ff0000cc;
    color:#fff;
    padding:8px 16px;
    border-radius:10px;
    display:none;
  }
  #restartBtn{
    display:none;
    position:absolute;
    top:70px;
    left:50%;
    transform:translateX(-50%);
    font-size:22px;
    padding:8px 16px;
  }
  #score{
    position:absolute;
    top:20px;
    left:20px;
    color:#fff;
    font-size:22px;
  }
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.164.1/build/three.module.js",
    "GLTFLoader": "https://unpkg.com/three@0.164.1/examples/jsm/loaders/GLTFLoader.js"
  }
}
</script>
</head>
<body>
<div id="ui">
  <button id="leftBtn">â¬…ï¸ ÙŠØ³Ø§Ø±</button>
  <button id="jumpBtn">â« Ù‚ÙØ²</button>
  <button id="rightBtn">â¡ï¸ ÙŠÙ…ÙŠÙ†</button>
</div>
<div id="status">ğŸ’¥ Ø§ØµØ·Ø¯Ø§Ù…!</div>
<button id="restartBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
<div id="score">Ù†Ù‚Ø§Ø·: 0</div>

<script type="module">
import * as THREE from "three";
import { GLTFLoader } from "GLTFLoader";

let scene,camera,renderer,mixer,clock;
let player, playerLane = 0;
let obstacles = [], buildings = [];
const lanes = [-2,0,2];
let speed = 0.2;
let gameOver = false;

// Ø§Ù„Ù‚ÙØ²
let isJumping = false;
let verticalVelocity = 0;
const gravity = -0.01;
const jumpStrength = 0.22;

// Ø§Ù„Ù†Ù‚Ø§Ø·
let score = 0;
const scoreElem = document.getElementById("score");

init();
animate();

function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  camera = new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,400);
  camera.position.set(0,2,-6);

  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
  const dir = new THREE.DirectionalLight(0xffffff,1);
  dir.position.set(5,10,5);
  scene.add(dir);

  // Ø´Ø§Ø±Ø¹
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(6,1000),
    new THREE.MeshStandardMaterial({color:0x333333})
  );
  road.rotation.x = -Math.PI/2;
  road.position.z = 500;
  scene.add(road);

  // Ø®Ø·ÙˆØ· Ø§Ù„Ø´Ø§Ø±Ø¹
  const lineMat = new THREE.MeshBasicMaterial({color:0xffffff});
  for(let i=0;i<120;i++){
    const line = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.01,2), lineMat);
    line.position.set(0,0.01,i*10);
    scene.add(line);
  }

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);

  clock = new THREE.Clock();

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©
  const loader = new GLTFLoader();
  loader.load("./freefire_running_animation__female.glb",(gltf)=>{
    player = gltf.scene;
    player.scale.set(1.2,1.2,1.2);
    player.position.set(0,0,0);
    scene.add(player);
    mixer = new THREE.AnimationMixer(player);
    gltf.animations.forEach((clip)=>{
      if(clip.name.toLowerCase().includes("run"))
         mixer.clipAction(clip).play();
    });
  });

  // Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª
  const coneGeo = new THREE.ConeGeometry(0.4,1,16);
  for(let i=0;i<40;i++){
    const coneMat = new THREE.MeshStandardMaterial({color:0xff3300});
    const cone = new THREE.Mesh(coneGeo,coneMat);
    cone.position.set(lanes[Math.floor(Math.random()*lanes.length)],0.5,i*12 + 20);
    scene.add(cone);
    obstacles.push(cone);
  }

  // Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
  for(let i=0;i<80;i++){
    const w = THREE.MathUtils.randFloat(3,6);
    const h = THREE.MathUtils.randFloat(5,15);
    const d = THREE.MathUtils.randFloat(3,6);
    const geo = new THREE.BoxGeometry(w,h,d);
    const mat = new THREE.MeshStandardMaterial();
    mat.color.setHSL(Math.random(),0.4,0.5);
    const building = new THREE.Mesh(geo,mat);
    const side = (i%2===0)? 8 : -8;
    building.position.set(side,h/2,i*15);
    scene.add(building);
    buildings.push(building);
  }

  // Ø§Ù„ØªØ­ÙƒÙ…
  document.getElementById("leftBtn").onclick = ()=>{ if(playerLane>-1) playerLane--; };
  document.getElementById("rightBtn").onclick = ()=>{ if(playerLane<1) playerLane++; };
  document.getElementById("jumpBtn").onclick = jump;
  document.getElementById("restartBtn").onclick = restartGame;

  window.addEventListener("resize", onResize);
  window.addEventListener("keydown",(e)=>{
    if(e.key==="ArrowLeft" && playerLane>-1) playerLane--;
    if(e.key==="ArrowRight" && playerLane<1) playerLane++;
    if(e.code==="Space") jump();
  });
}

function jump(){
  if(!player || isJumping || gameOver) return;
  isJumping = true;
  verticalVelocity = jumpStrength;
}

function restartGame(){
  gameOver = false;
  speed = 0.2;
  playerLane = 0;
  if(player) player.position.set(0,0,0);
  obstacles.forEach((c,i)=>{
    c.position.set(lanes[Math.floor(Math.random()*lanes.length)],0.5,i*12 + 20);
    c.material.color.set(0xff3300);
  });
  buildings.forEach((b,i)=>{ b.position.z = i*15; });
  score = 0;
  scoreElem.innerText = "Ù†Ù‚Ø§Ø·: 0";
  document.getElementById("status").style.display = "none";
  document.getElementById("restartBtn").style.display = "none";
}

function onResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate(){
  requestAnimationFrame(animate);
  const delta = clock.getDelta();
  if(mixer) mixer.update(delta);

  if(player && !gameOver){
    // Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„Ø£Ù…Ø§Ù…
    player.position.z += speed;
    player.position.x += (lanes[playerLane]-player.position.x)*0.2;

    // Ø§Ù„Ù‚ÙØ²
    if(isJumping){
      player.position.y += verticalVelocity;
      verticalVelocity += gravity;
      if(player.position.y <= 0){
        player.position.y = 0;
        isJumping = false;
        verticalVelocity = 0;
      }
    }

    // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨
    const camOffset = new THREE.Vector3(0,2,-6);
    const desiredPos = player.position.clone().add(camOffset);
    camera.position.lerp(desiredPos,0.1);
    camera.lookAt(player.position.x,1.5,player.position.z+6);

    // Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª
    obstacles.forEach(c=>{
      if(c.position.z + 10 < player.position.z){
        c.position.z = player.position.z + 400 + Math.random()*20;
        c.position.x = lanes[Math.floor(Math.random()*lanes.length)];
        c.material.color.set(0xff3300);
        score++;
        scoreElem.innerText = `Ù†Ù‚Ø§Ø·: ${score}`;
      }
      if(player.position.y < 0.6){
        const pBox = new THREE.Box3().setFromObject(player);
        const cBox = new THREE.Box3().setFromObject(c);
        if(pBox.intersectsBox(cBox)) collision();
      }
    });

    // Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
    buildings.forEach(b=>{
      if(b.position.z + 20 < player.position.z){
        b.position.z = player.position.z + 600 + Math.random()*50;
        const h = THREE.MathUtils.randFloat(5,15);
        b.scale.y = h / b.geometry.parameters.height;
        b.position.y = h/2;
      }
    });
  }

  renderer.render(scene,camera);
}

function collision(){
  if(gameOver) return;
  gameOver = true;
  speed = 0;
  document.getElementById("status").style.display = "block";
  document.getElementById("restartBtn").style.display = "block";
  obstacles.forEach(c => c.material.color.set(0xff0000));
}
</script>
</body>
</html>